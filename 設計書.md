# 基本設計書（要件定義・仕様書）

## 1.1 プロジェクト概要
OBS Studioのブラウザソースを用いて、マリオカート8デラックス風のアイテム抽選演出を行うWebアプリケーション。
配信画面に表示する「表示用画面（Display）」と、配信者が手元で操作する「操作用画面（Controller）」の2画面で構成され、相互に連携して動作する。

## 1.2 システム要件
- **プラットフォーム**: Windows PC / OBS Studio (Custom Browser Dock)
- **動作環境**: オフライン環境でも動作可能であること（ライブラリ等のローカル配置）。
- **構成**: サーバーレス構成。PBSの「カスタムブラウザドック」と「ブラウザソース」間で `localStorage` または `BroadcastChannel` を介した通信を行い同期する。

## 1.3 機能要件

### A. 抽選ロジック（デッキシステム）
- **共有デッキ制**: 全プレイヤー（1P〜4P）は、1つの「山札（デッキ）」を共有する。一度出現したアイテムは、山札から削除される（重複当選なし）。
- **山札の設定**: ユーザーがテキストエリアで自由に設定可能（改行区切りで1要素とする）。初期想定は「A〜L」の12要素だが、増減可能。
- **山札切れ時の挙動**: ユーザー設定により以下2パターンから選択可能とする。
    - **パターンA（ループ）**: 自動的に山札を初期状態にリセットし、重複を許容して抽選続行。
    - **パターンB（枯渇）**: 「ハズレ（MISS/✕）」のみを排出する。
- **保存機能**: ブラウザを閉じても「現在の山札の状態」「各プレイヤーの排出履歴」を保持する（Auto Save）。

### B. プレイヤー管理と表示制限
- **プレイヤー数**: 4名（1P, 2P, 3P, 4P）。
- **履歴表示数**: 1人あたり最大20個まで表示。20個に達した場合、そのプレイヤーの抽選ボタンは非活性（押下不可）とする。
- **リセット機能（分離実装）**:
    - **ゲームリセット**: 山札および全プレイヤーの履歴を全消去し、初期状態に戻す。
    - **位置リセット**: 表示位置のオフセット設定のみを初期値に戻す。

### C. UI/UXデザイン要件
- **デザインコンセプト**: マリオカート8デラックスのアイテムルーレットを模倣。黒の半透明背景（`rgba(0,0,0,0.5)`程度）に、金属的な光沢のある角丸枠線。
- **レイアウト挙動（Z型配置）**:
    - **基準点**: 各プレイヤーの1つ目のスロットの「左上」を固定基準とする。
    - **増殖方向**: 抽選されるたびに右方向へアイテム枠を追加する。
    - **折り返し**: 設定された「1行あたりの最大数（Columns）」を超えた場合、次の行（下段）の左端へ折り返す。
- **アニメーション演出**:
    - **挙動**: スロットが上奥へ回転し、下奥から手前に出てくる3D回転演出（ドラムロール）。
    - **シーケンス（計3.5秒）**:
        - 高速回転: 2.0秒
        - 減速演出: 1.0秒
        - 停止・確定: 0.5秒（発光エフェクト含む）
- **効果音**: なし。

# 詳細設計書（技術仕様書）

## 2.1 技術スタック
- **言語**: HTML5, CSS3, JavaScript (ES6+)
- **フレームワーク**: なし（Vanilla JS）
- **必須ライブラリ**:
    - **GSAP (GreenSock Animation Platform) v3**: アニメーション制御用。  
      ※`gsap.min.js` をローカルフォルダに同梱すること。
- **フォント**:
    - **Mochiy Pop One (Google Fonts)**: 日本語・ポップ体用
    - **Arial Black**: 英数字用  
      ※Webフォントファイル（woff2等）をローカルにダウンロードし、`@font-face`で読み込むこと。

## 2.2 通信プロトコル定義
操作画面（OBSカスタムブラウザドック）と表示画面（OBSブラウザソース）の連携には、`localStorage` イベント監視（または `BroadcastChannel`）を使用する。
※OBSの仕様により、ローカルファイル同士の `localStorage` 共有が制限される場合は `BroadcastChannel` を優先する。
- **Storage Key**: `obs_mk_lottery_v1` （固定）

### データ構造 (JSON)
書き込み時は常に以下のフォーマットを遵守すること。

```json
{
  "timestamp": 1734936000123, // データの鮮度判定用 (Date.now())
  "type": "SPIN",             // アクションタイプ
  "payload": {                // アクションに応じたデータ
    "playerId": 1,            // 対象プレイヤー (1-4)
    "slotIndex": 0,           // 何個目の履歴か (0-19)
    "resultValue": "A",       // 抽選結果の文字列
    "isMiss": false,          // ハズレフラグ (trueの場合バツ印を表示)
    "colorIndex": 0           // 配色パレットID (0-19)
  }
}
```

### Action Types
- **SPIN**: 抽選実行。スロットを追加し回転開始。
- **RESET_GAME**: 全データ消去・初期化。
- **UPDATE_CONFIG**: 位置調整やカラム数等の設定変更の即時反映。

## 2.3 配色パレット定義 (Color Palette)
抽選結果の文字色・背景色として、以下の20色をインデックス順に使用する。
CSS変数またはJS配列として定義すること。（視認性を重視し、色相環順に配置）

| Index | Color Code | Color Name | Index | Color Code | Color Name |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 0 | #FF0000 | Red | 10 | #00FF7F | SpringGreen |
| 1 | #FF4500 | OrangeRed | 11 | #00CED1 | DarkTurquoise |
| 2 | #FFA500 | Orange | 12 | #00BFFF | DeepSkyBlue |
| 3 | #FFD700 | Gold | 13 | #1E90FF | DodgerBlue |
| 4 | #FFFF00 | Yellow | 14 | #0000FF | Blue |
| 5 | #ADFF2F | GreenYellow | 15 | #8A2BE2 | BlueViolet |
| 6 | #00FF00 | Lime | 16 | #FF00FF | Magenta |
| 7 | #32CD32 | LimeGreen | 17 | #FF1493 | DeepPink |
| 8 | #008000 | Green | 18 | #C71585 | MediumVioletRed |
| 9 | #00FA9A | MediumSpringGreen | 19 | #A9A9A9 | DarkGray |

## 2.4 ファイル構成（納品物構成）
第三者が実装を開始する際のフォルダ構成基準。

```text
mk_lottery_tool
  ├ index.html      (表示用: OBSブラウザソースで読み込むファイル)
  ├ controller.html (操作用: OBSカスタムブラウザドックで読み込むファイル)
  ├ /assets
  │  ├ /css
  │  │  └ style.css (共通スタイルおよびアニメーション定義)
  │  ├ /js
  │  │  ├ app_display.js    (表示側の受信・描画ロジック)
  │  │  ├ app_controller.js (操作側の抽選・送信ロジック)
  │  │  └ gsap.min.js       (アニメーションライブラリ)
  │  └ /fonts
  │     └ MochiyPopOne-Regular.woff2
  └ README.txt      (利用方法)
```

## 2.5 実装上の注意点（開発者向け注記）
- **CSS 3D Transform**:
    - スロットの回転は、`transform-style: preserve-3d;` を使用した立方体（あるいは多角柱）の回転として実装すること。
    - 単なる画像の切り替えではなく、立体的な動きを必須とする。
- **同期ズレ対策**:
    - `localStorage` イベントは同一オリジン（同じドメイン、またはローカルファイルパス）でないと発火しない仕様に注意し、必ず同一フォルダ内のHTMLとして運用するようREADMEに記載すること。
    - OBSのカスタムドックとソース間での通信を確立するため、両方を「ローカルファイル」として読み込むか、必要に応じてOBS起動オプション（`--allow-file-access-from-files`）の使用を検討する。
- **ハズレ表示**:
    - `isMiss: true` のデータを受信した場合、文字ではなくCSSで描画した「太い赤色の✕印」または「ドクロアイコン」を表示すること。